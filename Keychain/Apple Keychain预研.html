<?xml version="1.0" encoding="UTF-8" standalone="no"?>
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html><head><meta http-equiv="Content-Type" content="text/html; charset=UTF-8"/><meta name="exporter-version" content="Evernote Mac 6.0.8 (451398)"/><meta name="author" content="yx113355@qq.com"/><meta name="created" content="2015-11-19 03:28:17 +0000"/><meta name="source" content="desktop.mac"/><meta name="updated" content="2015-11-19 11:36:49 +0000"/><title>Apple Keychain预研</title></head><body>
<div>首先到网上随意找介绍，熟悉概念，发现简单例子，但还是想全面了解，于是找Apple的例子，到【<a href="https://developer.apple.com/library/ios/samplecode/GenericKeychain/Introduction/Intro.html">https://developer.apple.com/library/ios/samplecode/GenericKeychain/Introduction/Intro.html</a>】下载。打开工程，看Readme文件。有这么一段描述：</div>
<div><span style="font: 14.0px Menlo; font-variant-ligatures: no-common-ligatures; color: #b9b28d">The sample must be edited to include your app ID prefix in five places where the text "YOUR_APP_ID_HERE"<br/>
appears before building and running the sample apps. The easiest way to do that is to use Xcode's Find in Project</span></div>
<div><span style="font-family: Menlo;"><span style="color: rgb(185, 178, 141);">command to locate the places that must be edited first. Just change the app ID prefix; leave the rest unchanged.</span></span></div>
<div><span style="font-family: Menlo;"><span style="color: rgb(185, 178, 141);"><br/></span></span></div>
<div><span style="font-family: Menlo;">意思是要用app的ID prefix去替换<span style="font-style: normal; font-variant: normal; font-weight: normal; font-size: 14px; font-family: Menlo;">YOUR_APP_ID_HERE这个字符串，一开始以为是Apple ID,提示Provision file不匹配。看网上例子是一串字符，以为是这个：</span></span></div>
<div><span style="font-family: Menlo;"><img src="Apple%20Keychain%E9%A2%84%E7%A0%94.resources/5DA035F6-D70F-41D2-896B-01CEF7B92362.png" height="39" width="333"/></span></div>
<div><font face="Menlo">括号里这串。也提示不匹配。</font></div>
<div><span style="font-family: Menlo;"><br/></span></div>
<div><span style="font-family: Menlo;">经同事提醒是<span style="font-style: normal; font-variant: normal; font-weight: normal; font-size: 14px; font-family: Menlo;">app ID prefix。用这个：</span></span></div>
<div><span style="font-family: Menlo;"><img src="Apple%20Keychain%E9%A2%84%E7%A0%94.resources/8F33CB0A-AA6C-4F5D-8601-72627A510E45.png" height="263" width="1035"/></span></div>
<div><span style="font-family: Menlo;">组织单位的字符串。（也可以命令行查看到：【</span> <span style="font: 11.0px Menlo; font-variant-ligatures: no-common-ligatures">security cms -D -i /Users/myusername/my.mobileprovision </span><span style="font-family: Menlo;">】）</span></div>
<div><span style="font-family: Menlo;"><br/></span></div>
<div><span style="font-family: Menlo;"><span style="font-family: Menlo;"><span style="font-style: normal; font-variant: normal; font-weight: normal; font-size: 14px; font-family: Menlo;">app ID prefix到底是什么，哪里可以看到？</span></span></span></div>
<div><span style="font-family: Menlo;">其实在开发者中心创建app id时有提示：<a href="https://developer.apple.com/account/ios/identifiers/bundle/bundleCreate.action"><span style="color: rgb(0, 0, 0);">https://developer.apple.com/account/ios/identifiers/bundle/bundleCreate.action</span></a></span></div>
<div><span style="font-family: Menlo;"><span style="color: rgb(185, 178, 141);"><img src="Apple%20Keychain%E9%A2%84%E7%A0%94.resources/ABABFA55-C027-48A4-8A33-9ADBA22FC7D7.png" height="606" width="923"/></span></span></div>
<div><span style="font-family: Menlo;"><span style="color: rgb(185, 178, 141);">也就是Team ID.</span></span></div>
<div>知道这个就一切简单了。</div>
<div><br/></div>
<div><br/></div>
<div>配置信息：</div>
<div><img src="Apple%20Keychain%E9%A2%84%E7%A0%94.resources/8BB6466C-BA2A-4C3F-A0E2-3C2E730EBEEB.png" height="215" width="571"/></div>
<div><img src="Apple%20Keychain%E9%A2%84%E7%A0%94.resources/539EF72D-9559-470E-A002-48655BD1ABCB.png" height="546" width="861"/></div>
<div><br/></div>
<div><img src="Apple%20Keychain%E9%A2%84%E7%A0%94.resources/51A050DD-3B28-44AB-B387-5FECFEE656FE.png" height="29" width="1237"/></div>
<div><br/></div>
<div><br/></div>
<div><span style="color: rgb(255, 38, 0);">运行时还有一个编译错误是因为我用的xcode7， bitcode配置默认是YES，而这份代码非常早了，把这个改为NO。</span></div>
<div><br/></div>
<div><br/></div>
<div><br/></div>
<div>
<hr/></div>
<div><br/></div>
<div>那不付费的开发证书可以吗？</div>
<div><br/></div>
<div>
<hr/></div>
<div>代码理解：</div>
<div><b><span style="font-size: 36px;">一、查询</span></b></div>
<div><span style="font-size: 24px;"><b>1、类型： <span style="font-style: normal; font-variant: normal; font-weight: normal; line-height: normal; font-family: Menlo;"><b>kSecClass -安全项的类别</b></span></b></span></div>
<div><span style="font-family: Menlo;">系统定义了这几种：</span></div>
<div><span style="font-family: Menlo;"><span style="color: rgb(185, 178, 141);"><span style="font: 14.0px Menlo; font-variant-ligatures: no-common-ligatures; color: #e03b4b">extern</span> <span style="font: 14.0px Menlo; font-variant-ligatures: no-common-ligatures; color: #e03b4b">const</span> <span style="font: 14.0px Menlo; font-variant-ligatures: no-common-ligatures; color: #6c6fc6">CFStringRef</span> <span style="font: 14.0px Menlo; font-variant-ligatures: no-common-ligatures; color: #b9b28d">kSecClassGenericPassword<br/>
   </span> <span style="font: 14.0px Menlo; font-variant-ligatures: no-common-ligatures; color: #d84969">__OSX_AVAILABLE_STARTING</span><span style="font: 14.0px Menlo; font-variant-ligatures: no-common-ligatures; color: #b9b28d">(__MAC_10_7, __IPHONE_2_0);<br/></span><span style="font: 14.0px Menlo; font-variant-ligatures: no-common-ligatures; color: #e03b4b">extern</span> <span style="font: 14.0px Menlo; font-variant-ligatures: no-common-ligatures; color: #e03b4b">const</span> <span style="font: 14.0px Menlo; font-variant-ligatures: no-common-ligatures; color: #6c6fc6">CFStringRef</span> <span style="font: 14.0px Menlo; font-variant-ligatures: no-common-ligatures; color: #b9b28d">kSecClassInternetPassword<br/>
   </span> <span style="font: 14.0px Menlo; font-variant-ligatures: no-common-ligatures; color: #d84969">__OSX_AVAILABLE_STARTING</span><span style="font: 14.0px Menlo; font-variant-ligatures: no-common-ligatures; color: #b9b28d">(__MAC_10_6, __IPHONE_2_0);<br/></span><span style="font: 14.0px Menlo; font-variant-ligatures: no-common-ligatures; color: #e03b4b">extern</span> <span style="font: 14.0px Menlo; font-variant-ligatures: no-common-ligatures; color: #e03b4b">const</span> <span style="font: 14.0px Menlo; font-variant-ligatures: no-common-ligatures; color: #6c6fc6">CFStringRef</span> <span style="font: 14.0px Menlo; font-variant-ligatures: no-common-ligatures; color: #b9b28d">kSecClassCertificate<br/>
   </span> <span style="font: 14.0px Menlo; font-variant-ligatures: no-common-ligatures; color: #d84969">__OSX_AVAILABLE_STARTING</span><span style="font: 14.0px Menlo; font-variant-ligatures: no-common-ligatures; color: #b9b28d">(__MAC_10_7, __IPHONE_2_0);<br/></span><span style="font: 14.0px Menlo; font-variant-ligatures: no-common-ligatures; color: #e03b4b">extern</span> <span style="font: 14.0px Menlo; font-variant-ligatures: no-common-ligatures; color: #e03b4b">const</span> <span style="font: 14.0px Menlo; font-variant-ligatures: no-common-ligatures; color: #6c6fc6">CFStringRef</span> <span style="font: 14.0px Menlo; font-variant-ligatures: no-common-ligatures; color: #b9b28d">kSecClassKey<br/>
   </span> <span style="font: 14.0px Menlo; font-variant-ligatures: no-common-ligatures; color: #d84969">__OSX_AVAILABLE_STARTING</span><span style="font: 14.0px Menlo; font-variant-ligatures: no-common-ligatures; color: #b9b28d">(__MAC_10_7, __IPHONE_2_0);<br/></span><span style="font: 14.0px Menlo; font-variant-ligatures: no-common-ligatures; color: #e03b4b">extern</span> <span style="font: 14.0px Menlo; font-variant-ligatures: no-common-ligatures; color: #e03b4b">const</span> <span style="font: 14.0px Menlo; font-variant-ligatures: no-common-ligatures; color: #6c6fc6">CFStringRef</span> <span style="font: 14.0px Menlo; font-variant-ligatures: no-common-ligatures; color: #b9b28d">kSecClassIdentity</span></span></span></div>
<div><span style="font-family: Menlo;"><span style="color: rgb(185, 178, 141);">   </span> <span style="font: 14.0px Menlo; font-variant-ligatures: no-common-ligatures; color: #d84969">__OSX_AVAILABLE_STARTING</span><span style="font: 14.0px Menlo; font-variant-ligatures: no-common-ligatures; color: #b9b28d">(__MAC_10_7, __IPHONE_2_0);</span></span></div>
<div><span style="font-family: Menlo;"><span style="color: rgb(185, 178, 141);"><br/></span></span></div>
<div>其实可以参考mac上的钥匙串来理解</div>
<div><img src="Apple%20Keychain%E9%A2%84%E7%A0%94.resources/F82503FC-13F4-4306-A422-075F5F5B5C0E.png" height="976" width="968"/></div>
<div>eg： <span style="font: 14.0px Menlo; font-variant-ligatures: no-common-ligatures; color: #b9b28d">[</span><span style="font: 14.0px Menlo; font-variant-ligatures: no-common-ligatures; color: #71b891">genericPasswordQuery</span> <span style="font: 14.0px Menlo; font-variant-ligatures: no-common-ligatures; color: #5096b7">setObject</span><span style="font: 14.0px Menlo; font-variant-ligatures: no-common-ligatures; color: #b9b28d">:(</span><span style="font: 14.0px Menlo; font-variant-ligatures: no-common-ligatures; color: #e03b4b">id</span><span style="font: 14.0px Menlo; font-variant-ligatures: no-common-ligatures; color: #b9b28d">)</span><span style="font: 14.0px Menlo; font-variant-ligatures: no-common-ligatures; color: #71b891">kSecClassGenericPassword</span> <span style="font: 14.0px Menlo; font-variant-ligatures: no-common-ligatures; color: #5096b7">forKey</span><span style="font: 14.0px Menlo; font-variant-ligatures: no-common-ligatures; color: #b9b28d">:(</span><span style="font: 14.0px Menlo; font-variant-ligatures: no-common-ligatures; color: #e03b4b">id</span><span style="font: 14.0px Menlo; font-variant-ligatures: no-common-ligatures; color: #b9b28d">)</span><span style="font: 14.0px Menlo; font-variant-ligatures: no-common-ligatures; color: #71b891">kSecClass</span><span style="font: 14.0px Menlo; font-variant-ligatures: no-common-ligatures; color: #b9b28d">];</span></div>
<div><br/></div>
<div><span style="font-size: 24px;"><b>2、属性</b></span></div>
<div><span style="font-family: Menlo;">SecItem.h中定义了每种类型支持的属性，如：</span></div>
<div><span style="font-family: Menlo;"><span style="color: rgb(185, 178, 141);"><img src="Apple%20Keychain%E9%A2%84%E7%A0%94.resources/B047AFA6-8698-42A0-8344-7825A0536433.png" height="380" width="654"/></span></span></div>
<div><span style="font-family: Menlo;"><span style="color: rgb(185, 178, 141);">eg： <span style="font: 14.0px Menlo; font-variant-ligatures: no-common-ligatures; color: #b9b28d">[</span><span style="font: 14.0px Menlo; font-variant-ligatures: no-common-ligatures; color: #71b891">genericPasswordQuery</span> <span style="font: 14.0px Menlo; font-variant-ligatures: no-common-ligatures; color: #5096b7">setObject</span><span style="font: 14.0px Menlo; font-variant-ligatures: no-common-ligatures; color: #b9b28d">:identifier</span> <span style="font: 14.0px Menlo; font-variant-ligatures: no-common-ligatures; color: #5096b7">forKey</span><span style="font: 14.0px Menlo; font-variant-ligatures: no-common-ligatures; color: #b9b28d">:(</span><span style="font: 14.0px Menlo; font-variant-ligatures: no-common-ligatures; color: #e03b4b">id</span><span style="font: 14.0px Menlo; font-variant-ligatures: no-common-ligatures; color: #b9b28d">)</span><span style="font: 14.0px Menlo; font-variant-ligatures: no-common-ligatures; color: #71b891">kSecAttrGeneric</span><span style="font: 14.0px Menlo; font-variant-ligatures: no-common-ligatures; color: #b9b28d">];</span></span></span></div>
<div><span style="font-family: Menlo;">如果用了Group，加上这个属性：<span style="color: rgb(185, 178, 141);"><span style="font: 14.0px Menlo; font-variant-ligatures: no-common-ligatures; color: #b9b28d">[</span></span><span style="font: 14.0px Menlo; font-variant-ligatures: no-common-ligatures; color: #71b891">genericPasswordQuery</span> <span style="font: 14.0px Menlo; font-variant-ligatures: no-common-ligatures; color: #5096b7">setObject</span><span style="font: 14.0px Menlo; font-variant-ligatures: no-common-ligatures; color: #b9b28d">:accessGroup</span> <span style="font: 14.0px Menlo; font-variant-ligatures: no-common-ligatures; color: #5096b7">forKey</span><span style="font: 14.0px Menlo; font-variant-ligatures: no-common-ligatures; color: #b9b28d">:(</span><span style="font: 14.0px Menlo; font-variant-ligatures: no-common-ligatures; color: #e03b4b">id</span><span style="font: 14.0px Menlo; font-variant-ligatures: no-common-ligatures; color: #b9b28d">)</span><span style="font: 14.0px Menlo; font-variant-ligatures: no-common-ligatures; color: #71b891">kSecAttrAccessGroup</span><span style="font: 14.0px Menlo; font-variant-ligatures: no-common-ligatures; color: #b9b28d">];</span></span></div>
<div><span style="font-family: Menlo;"><span style="font-family: Menlo;"><span style="font-style: normal; font-variant: normal; font-weight: normal; font-size: 14px; line-height: normal; font-family: Menlo;">accessGroup就是多个App中用来标识共享数据的唯一id，以你的带前缀的app id开头且要设定到工程设置的code signing entitlements文件中。</span></span></span><span style="font-family: Menlo;"><span style="color: rgb(185, 178, 141);"><br/></span></span></div>
<div><span style="font-family: Menlo;"><span style="color: rgb(185, 178, 141);"><br/></span></span></div>
<div><span style="font-size: 24px;"><b><span style="font-family: Menlo;">3、数据匹配策略：<span style="font-style: normal; font-variant: normal; font-weight: normal; line-height: normal; font-family: Menlo;"><b>kSecMatchPolicy系统定义了很多匹配策略，可以根据需要选取</b></span></span></b></span></div>
<div><span style="font-family: Menlo;"><span style="color: rgb(185, 178, 141);"><span style="font: 14.0px Menlo; font-variant-ligatures: no-common-ligatures; color: #b9b28d">[</span><span style="font: 14.0px Menlo; font-variant-ligatures: no-common-ligatures; color: #71b891">genericPasswordQuery</span> <span style="font: 14.0px Menlo; font-variant-ligatures: no-common-ligatures; color: #5096b7">setObject</span><span style="font: 14.0px Menlo; font-variant-ligatures: no-common-ligatures; color: #b9b28d">:(</span><span style="font: 14.0px Menlo; font-variant-ligatures: no-common-ligatures; color: #e03b4b">id</span><span style="font: 14.0px Menlo; font-variant-ligatures: no-common-ligatures; color: #b9b28d">)</span><span style="font: 14.0px Menlo; font-variant-ligatures: no-common-ligatures; color: #71b891">kSecMatchLimitOne</span> <span style="font: 14.0px Menlo; font-variant-ligatures: no-common-ligatures; color: #5096b7">forKey</span><span style="font: 14.0px Menlo; font-variant-ligatures: no-common-ligatures; color: #b9b28d">:(</span><span style="font: 14.0px Menlo; font-variant-ligatures: no-common-ligatures; color: #e03b4b">id</span><span style="font: 14.0px Menlo; font-variant-ligatures: no-common-ligatures; color: #b9b28d">)</span><span style="font: 14.0px Menlo; font-variant-ligatures: no-common-ligatures; color: #71b891">kSecMatchLimit</span><span style="font: 14.0px Menlo; font-variant-ligatures: no-common-ligatures; color: #b9b28d">];</span></span></span></div>
<div><span style="font-family: Menlo;"><span style="color: rgb(185, 178, 141);"><br/></span></span></div>
<div><span style="font-size: 24px;"><b><span style="font-family: Menlo;">4、返回数据的类型：<span style="font-family: Menlo;"><span style="font-style: normal; font-variant: normal; font-weight: normal; line-height: normal; font-family: Menlo;"><b>kSecReturnData</b></span></span></span></b></span></div>
<div>有这几种：</div>
<div><span style="font-family: Menlo;"><span style="color: rgb(113, 184, 145);"><span style="font: 14.0px Menlo; font-variant-ligatures: no-common-ligatures; color: #e03b4b">extern</span> <span style="font: 14.0px Menlo; font-variant-ligatures: no-common-ligatures; color: #e03b4b">const</span> <span style="font: 14.0px Menlo; font-variant-ligatures: no-common-ligatures; color: #6c6fc6">CFStringRef</span> <span style="font: 14.0px Menlo; font-variant-ligatures: no-common-ligatures; color: #b9b28d">kSecReturnData<br/>
   </span> <span style="font: 14.0px Menlo; font-variant-ligatures: no-common-ligatures; color: #d84969">__OSX_AVAILABLE_STARTING</span><span style="font: 14.0px Menlo; font-variant-ligatures: no-common-ligatures; color: #b9b28d">(__MAC_10_6, __IPHONE_2_0);<br/></span><span style="font: 14.0px Menlo; font-variant-ligatures: no-common-ligatures; color: #e03b4b">extern</span> <span style="font: 14.0px Menlo; font-variant-ligatures: no-common-ligatures; color: #e03b4b">const</span> <span style="font: 14.0px Menlo; font-variant-ligatures: no-common-ligatures; color: #6c6fc6">CFStringRef</span> <span style="font: 14.0px Menlo; font-variant-ligatures: no-common-ligatures; color: #b9b28d">kSecReturnAttributes<br/>
   </span> <span style="font: 14.0px Menlo; font-variant-ligatures: no-common-ligatures; color: #d84969">__OSX_AVAILABLE_STARTING</span><span style="font: 14.0px Menlo; font-variant-ligatures: no-common-ligatures; color: #b9b28d">(__MAC_10_6, __IPHONE_2_0);<br/></span><span style="font: 14.0px Menlo; font-variant-ligatures: no-common-ligatures; color: #e03b4b">extern</span> <span style="font: 14.0px Menlo; font-variant-ligatures: no-common-ligatures; color: #e03b4b">const</span> <span style="font: 14.0px Menlo; font-variant-ligatures: no-common-ligatures; color: #6c6fc6">CFStringRef</span> <span style="font: 14.0px Menlo; font-variant-ligatures: no-common-ligatures; color: #b9b28d">kSecReturnRef<br/>
   </span> <span style="font: 14.0px Menlo; font-variant-ligatures: no-common-ligatures; color: #d84969">__OSX_AVAILABLE_STARTING</span><span style="font: 14.0px Menlo; font-variant-ligatures: no-common-ligatures; color: #b9b28d">(__MAC_10_6, __IPHONE_2_0);<br/></span><span style="font: 14.0px Menlo; font-variant-ligatures: no-common-ligatures; color: #e03b4b">extern</span> <span style="font: 14.0px Menlo; font-variant-ligatures: no-common-ligatures; color: #e03b4b">const</span> <span style="font: 14.0px Menlo; font-variant-ligatures: no-common-ligatures; color: #6c6fc6">CFStringRef</span> <span style="font: 14.0px Menlo; font-variant-ligatures: no-common-ligatures; color: #b9b28d">kSecReturnPersistentRef</span></span></span></div>
<div><span style="font-family: Menlo;"><span style="color: rgb(185, 178, 141);">   </span> <span style="font: 14.0px Menlo; font-variant-ligatures: no-common-ligatures; color: #d84969">__OSX_AVAILABLE_STARTING</span><span style="font: 14.0px Menlo; font-variant-ligatures: no-common-ligatures; color: #b9b28d">(__MAC_10_6, __IPHONE_2_0);</span></span></div>
<div><span style="font-family: Menlo;"><span style="color: rgb(185, 178, 141);">eg：[</span><span style="font: 14.0px Menlo; font-variant-ligatures: no-common-ligatures; color: #71b891">genericPasswordQuery</span> <span style="font: 14.0px Menlo; font-variant-ligatures: no-common-ligatures; color: #5096b7">setObject</span><span style="font: 14.0px Menlo; font-variant-ligatures: no-common-ligatures; color: #b9b28d">:(</span><span style="font: 14.0px Menlo; font-variant-ligatures: no-common-ligatures; color: #e03b4b">id</span><span style="font: 14.0px Menlo; font-variant-ligatures: no-common-ligatures; color: #b9b28d">)</span><span style="font: 14.0px Menlo; font-variant-ligatures: no-common-ligatures; color: #71b891">kCFBooleanTrue</span> <span style="font: 14.0px Menlo; font-variant-ligatures: no-common-ligatures; color: #5096b7">forKey</span><span style="font: 14.0px Menlo; font-variant-ligatures: no-common-ligatures; color: #b9b28d">:(</span><span style="font: 14.0px Menlo; font-variant-ligatures: no-common-ligatures; color: #e03b4b">id</span><span style="font: 14.0px Menlo; font-variant-ligatures: no-common-ligatures; color: #b9b28d">)</span><span style="font: 14.0px Menlo; font-variant-ligatures: no-common-ligatures; color: #71b891">kSecReturnAttributes</span><span style="font: 14.0px Menlo; font-variant-ligatures: no-common-ligatures; color: #b9b28d">];</span></span></div>
<div><span style="font-family: Menlo;"><span style="color: rgb(185, 178, 141);"><br/></span></span></div>
<div><span style="font-size: 24px;"><b><span style="font-family: Menlo;">5、执行查询</span></b></span></div>
<div>根据设定的返回类型，用合适的变量去接收数据</div>
<div><span style="font-family: Menlo;"><span style="color: rgb(185, 178, 141);"><span style="font: 14.0px Menlo; font-variant-ligatures: no-common-ligatures; color: #cf6354">NSDictionary</span> <span style="font: 14.0px Menlo; font-variant-ligatures: no-common-ligatures; color: #b9b28d">*tempQuery = [</span><span style="font: 14.0px Menlo; font-variant-ligatures: no-common-ligatures; color: #cf6354">NSDictionary</span> <span style="font: 14.0px Menlo; font-variant-ligatures: no-common-ligatures; color: #5096b7">dictionaryWithDictionary</span><span style="font: 14.0px Menlo; font-variant-ligatures: no-common-ligatures; color: #b9b28d">:</span><span style="font: 14.0px Menlo; font-variant-ligatures: no-common-ligatures; color: #71b891">genericPasswordQuery</span><span style="font: 14.0px Menlo; font-variant-ligatures: no-common-ligatures; color: #b9b28d">];</span></span></span></div>
<div><span style="font-family: Menlo;"><span style="font: 14.0px Menlo; font-variant-ligatures: no-common-ligatures; color: #cf6354">NSMutableDictionary</span> <span style="font: 14.0px Menlo; font-variant-ligatures: no-common-ligatures; color: #b9b28d">*outDictionary =</span> <span style="font: 14.0px Menlo; font-variant-ligatures: no-common-ligatures; color: #e03b4b">nil</span><span style="color: rgb(185, 178, 141);">;</span></span></div>
<div><span style="font-family: Menlo;"><span style="font: 14.0px Menlo; font-variant-ligatures: no-common-ligatures; color: #e03b4b">if</span> <span style="font: 14.0px Menlo; font-variant-ligatures: no-common-ligatures; color: #b9b28d">(!</span> <span style="font: 14.0px Menlo; font-variant-ligatures: no-common-ligatures; color: #5096b7">SecItemCopyMatching</span><span style="font: 14.0px Menlo; font-variant-ligatures: no-common-ligatures; color: #b9b28d">((</span><span style="font: 14.0px Menlo; font-variant-ligatures: no-common-ligatures; color: #6c6fc6">CFDictionaryRef</span><span style="font: 14.0px Menlo; font-variant-ligatures: no-common-ligatures; color: #b9b28d">)tempQuery, (</span><span style="font: 14.0px Menlo; font-variant-ligatures: no-common-ligatures; color: #6c6fc6">CFTypeRef</span> <span style="font: 14.0px Menlo; font-variant-ligatures: no-common-ligatures; color: #b9b28d">*)&amp;outDictionary) ==</span> <span style="font: 14.0px Menlo; font-variant-ligatures: no-common-ligatures; color: #7573b7">noErr</span><span style="font: 14.0px Menlo; font-variant-ligatures: no-common-ligatures; color: #b9b28d">)</span></span></div>
<div><br/></div>
<div><b><span style="font-size: 24px;">6、从返回结果中取数据</span></b></div>
<div>设定要取的数据类型和类别</div>
<div><span style="font: 14.0px Menlo; font-variant-ligatures: no-common-ligatures; color: #707070">// Add the proper search key and class attribute.</span></div>
<div><span style="font-family: Menlo;"><span style="color: rgb(185, 178, 141);">[returnDictionary</span> <span style="font: 14.0px Menlo; font-variant-ligatures: no-common-ligatures; color: #5096b7">setObject</span><span style="font: 14.0px Menlo; font-variant-ligatures: no-common-ligatures; color: #b9b28d">:(</span><span style="font: 14.0px Menlo; font-variant-ligatures: no-common-ligatures; color: #e03b4b">id</span><span style="font: 14.0px Menlo; font-variant-ligatures: no-common-ligatures; color: #b9b28d">)</span><span style="font: 14.0px Menlo; font-variant-ligatures: no-common-ligatures; color: #71b891">kCFBooleanTrue</span> <span style="font: 14.0px Menlo; font-variant-ligatures: no-common-ligatures; color: #5096b7">forKey</span><span style="font: 14.0px Menlo; font-variant-ligatures: no-common-ligatures; color: #b9b28d">:(</span><span style="font: 14.0px Menlo; font-variant-ligatures: no-common-ligatures; color: #e03b4b">id</span><span style="font: 14.0px Menlo; font-variant-ligatures: no-common-ligatures; color: #b9b28d">)</span><span style="font: 14.0px Menlo; font-variant-ligatures: no-common-ligatures; color: #71b891">kSecReturnData</span><span style="color: rgb(185, 178, 141);">];</span></span></div>
<div><span style="font: 14.0px Menlo; font-variant-ligatures: no-common-ligatures; color: #b9b28d">[returnDictionary</span> <span style="font: 14.0px Menlo; font-variant-ligatures: no-common-ligatures; color: #5096b7">setObject</span><span style="font: 14.0px Menlo; font-variant-ligatures: no-common-ligatures; color: #b9b28d">:(</span><span style="font: 14.0px Menlo; font-variant-ligatures: no-common-ligatures; color: #e03b4b">id</span><span style="font: 14.0px Menlo; font-variant-ligatures: no-common-ligatures; color: #b9b28d">)</span><span style="font: 14.0px Menlo; font-variant-ligatures: no-common-ligatures; color: #71b891">kSecClassGenericPassword</span> <span style="font: 14.0px Menlo; font-variant-ligatures: no-common-ligatures; color: #5096b7">forKey</span><span style="font: 14.0px Menlo; font-variant-ligatures: no-common-ligatures; color: #b9b28d">:(</span><span style="font: 14.0px Menlo; font-variant-ligatures: no-common-ligatures; color: #e03b4b">id</span><span style="font: 14.0px Menlo; font-variant-ligatures: no-common-ligatures; color: #b9b28d">)</span><span style="font: 14.0px Menlo; font-variant-ligatures: no-common-ligatures; color: #71b891">kSecClass</span><span style="color: rgb(185, 178, 141);"><span style="font-family: Menlo;">];</span></span></div>
<div><span style="font: 14.0px Menlo; font-variant-ligatures: no-common-ligatures; color: #b9b28d">   </span></div>
<div><span style="font-family: Menlo;"><span style="font: 14.0px Menlo; font-variant-ligatures: no-common-ligatures; color: #707070">// Acquire the password data from the attributes.</span></span></div>
<div><span style="font: 14.0px Menlo; font-variant-ligatures: no-common-ligatures; color: #cf6354">NSData</span> <span style="font: 14.0px Menlo; font-variant-ligatures: no-common-ligatures; color: #b9b28d">*passwordData =</span> <span style="font: 14.0px Menlo; font-variant-ligatures: no-common-ligatures; color: #e03b4b">NULL</span><span style="font: 14.0px Menlo; font-variant-ligatures: no-common-ligatures; color: #b9b28d">;</span></div>
<div><span style="font-family: Menlo;"><span style="font: 14.0px Menlo; font-variant-ligatures: no-common-ligatures; color: #e03b4b">if</span> <span style="font: 14.0px Menlo; font-variant-ligatures: no-common-ligatures; color: #b9b28d">(</span><span style="font: 14.0px Menlo; font-variant-ligatures: no-common-ligatures; color: #5096b7">SecItemCopyMatching</span><span style="font: 14.0px Menlo; font-variant-ligatures: no-common-ligatures; color: #b9b28d">((</span><span style="font: 14.0px Menlo; font-variant-ligatures: no-common-ligatures; color: #6c6fc6">CFDictionaryRef</span><span style="font: 14.0px Menlo; font-variant-ligatures: no-common-ligatures; color: #b9b28d">)returnDictionary, (</span><span style="font: 14.0px Menlo; font-variant-ligatures: no-common-ligatures; color: #6c6fc6">CFTypeRef</span> <span style="font: 14.0px Menlo; font-variant-ligatures: no-common-ligatures; color: #b9b28d">*)&amp;passwordData) ==</span> <span style="font: 14.0px Menlo; font-variant-ligatures: no-common-ligatures; color: #7573b7">noErr</span><span style="font: 14.0px Menlo; font-variant-ligatures: no-common-ligatures; color: #b9b28d">)</span></span></div>
<div><span style="font-family: Menlo;"><span style="color: rgb(185, 178, 141);"><br/></span></span></div>
<div><b><span style="font-size: 24px;"><font face="Menlo">二、增加和更新数据</font></span></b></div>
<div><span style="font-family: Menlo;">用 <span style="font-style: normal; font-variant: normal; font-weight: normal; font-size: 14px; line-height: normal; font-family: Menlo;">SecItemCopyMatching检查是否存在，不存在就调用<span style="font-style: normal; font-variant: normal; font-weight: normal; font-size: 14px; line-height: normal; font-family: Menlo;">SecItemAdd添加，否则用 <span style="font-style: normal; font-variant: normal; font-weight: normal; font-size: 14px; line-height: normal; font-family: Menlo;">SecItemUpdate更新。</span></span></span></span></div>
<div>对于更新的第二个参数有这样的要求：<span style="color: rgb(0, 0, 0); font-family: '.HelveticaNeueDeskInterface-Regular'; font-size: 11px; font-style: normal; font-variant: normal; font-weight: normal; letter-spacing: normal; orphans: auto; text-align: start; text-indent: 0px; text-transform: none; white-space: normal; widows: auto; word-spacing: 0px; -webkit-text-stroke-width: 0px; float: none;">Only real keychain attributes are permitted in this dictionary (no "meta" attributes are allowed.) </span></div>
<div>所以例子里把kSecClass移除了: <span style="font: 14.0px Menlo; font-variant-ligatures: no-common-ligatures; color: #b9b28d">[tempCheck</span> <span style="font: 14.0px Menlo; font-variant-ligatures: no-common-ligatures; color: #5096b7">removeObjectForKey</span><span style="font: 14.0px Menlo; font-variant-ligatures: no-common-ligatures; color: #b9b28d">:(</span><span style="font: 14.0px Menlo; font-variant-ligatures: no-common-ligatures; color: #e03b4b">id</span><span style="font: 14.0px Menlo; font-variant-ligatures: no-common-ligatures; color: #b9b28d">)</span><span style="font: 14.0px Menlo; font-variant-ligatures: no-common-ligatures; color: #71b891">kSecClass</span><span style="font: 14.0px Menlo; font-variant-ligatures: no-common-ligatures; color: #b9b28d">];</span></div>
<div><span style="font-family: Menlo;"><span style="color: rgb(185, 178, 141);"><br/></span></span></div>
<div><b><span style="font-size: 24px;">三、删除数据</span></b></div>
<div>调用 <span style="font-style: normal; font-variant: normal; font-weight: normal; font-size: 14px; line-height: normal; font-family: Menlo;"><span style="color: rgb(80, 150, 183);">SecItemDelete</span><span style="background-color: rgb(255, 250, 165);-evernote-highlight:true;">就行：</span></span></div>
<div><span style="font-family: Menlo;"><span style="color: rgb(80, 150, 183);"><span style="font: 14.0px Menlo; font-variant-ligatures: no-common-ligatures; color: #cf6354">NSMutableDictionary</span> <span style="font: 14.0px Menlo; font-variant-ligatures: no-common-ligatures; color: #b9b28d">*tempDictionary = [</span><span style="font: 14.0px Menlo; font-variant-ligatures: no-common-ligatures; color: #e03b4b">self</span> <span style="font: 14.0px Menlo; font-variant-ligatures: no-common-ligatures; color: #62989c">dictionaryToSecItemFormat</span><span style="font: 14.0px Menlo; font-variant-ligatures: no-common-ligatures; color: #b9b28d">:</span><span style="font: 14.0px Menlo; font-variant-ligatures: no-common-ligatures; color: #71b891">keychainItemData</span><span style="font: 14.0px Menlo; font-variant-ligatures: no-common-ligatures; color: #b9b28d">];</span></span></span></div>
<div><span style="font-family: Menlo;"><span style="color: rgb(185, 178, 141);">junk =</span> <span style="font: 14.0px Menlo; font-variant-ligatures: no-common-ligatures; color: #5096b7">SecItemDelete</span><span style="font: 14.0px Menlo; font-variant-ligatures: no-common-ligatures; color: #b9b28d">((</span><span style="font: 14.0px Menlo; font-variant-ligatures: no-common-ligatures; color: #6c6fc6">CFDictionaryRef</span><span style="font: 14.0px Menlo; font-variant-ligatures: no-common-ligatures; color: #b9b28d">)tempDictionary);</span></span></div>
<div><span style="font-family: Menlo;"><span style="color: rgb(185, 178, 141);"><br/></span></span></div>
</body></html>